{% extends 'base.jinja2' %}
{% from 'macros/generate_filter_criteria_dropdowns.jinja2' import  generate_filter_criteria_dropdowns %}
{% from 'macros/generate_map_chart.jinja2' import  generate_map_chart %}
{% from 'macros/performance_indicator_data.jinja2' import  performance_indicator_data %}
{% from 'macros/update_selected_location_dropdowns.jinja2' import update_selected_location_dropdowns %}

{% block title %}{% trans %}Performance Indicators{% endtrans %}{% endblock %}

{% block page_title %}
  <h3 class="page-title">
    {{ self.title() }}
    <small></small>
  </h3>
{% endblock %}

{% block breadcrumbs %}
  <li>{{ self.title() }}</li>
  <li><a href="#"> </a></li>
{% endblock %}

{% block filters %}
     {{ generate_filter_criteria_dropdowns(request, filter_criteria, search_criteria) }}
{% endblock %}

{% block content %}
    {{ generate_map_chart(request) }}
    <!-- Loop though the different sectors -->
    <div>
      {% if location %}
        {{ location.pretty }} {{ location.location_type | humanize() | title()}}
      {% else %}
        {% trans %}All Counties{% endtrans %}
      {% endif %}
    </div>
    {% for sector, report, label in sectors %}
      {% set rows = sector_data[sector].rows %}
      {% set summary_row = sector_data[sector].summary_row %}
      {% set indicators = sector_indicators[sector] %}
      <div class="row">
        <div class="col-md-12">
          <!-- BEGIN SAMPLE TABLE PORTLET-->
          <div class="portlet">
            <div class="portlet-title">
              <div class="caption">
                <i class="icon-tasks"></i>
                {{ label }}
              </div>
              <span class="pull-right">
                {% if location %}
                  <a href="{{ request.route_url('performance_indicators', traverse=(location.id),
                      _query={'format':'xlsx', 'view_by': search_criteria.get('view_by')})}}" class="btn btn-success download" role="button">
                      <i class="glyphicon glyphicon-download"></i> &nbsp;Download XLS 
                  </a>
                {% else %}
                  <a href="{{ request.route_url('performance_indicators', traverse=(),
                      _query={'format':'xlsx', 'view_by': search_criteria.get('view_by')})}}" class="btn btn-success download" role="button">
                      <i class="glyphicon glyphicon-download"></i> &nbsp;Download XLS 
                  </a>
                {% endif %}
              </span>
            </div>
            <div class="portlet-body">
              <div class="table-responsive table-scrollable">
                <table class="table table-striped table-bordered table-hover">
                  <thead>
                  <tr>
                  {% if target_class %}
                    <th>{{target_class.__name__}}</th>
                  {% else %}
                    <th>{% trans %}County{% endtrans %}</th>
                  {% endif %}
                    {% for label, key_group in indicators %}
                      <th class="data-header">{{ label }}</th>
                    {% endfor %}
                  </tr>
                  </thead>

                  <tbody>
                  {% for row in rows %}
                    <tr>
                      <td>
                        <a href="{{row.location.url(request, 'performance_indicators') }}">{{ row.location.pretty }}</a>
                      </td>
                      {% for label, key_group in indicators %}

                        {{ performance_indicator_data(request, row.indicators[key_group[0]],
                                                      row.indicators[key_group[1]],
                                                      row.indicators[key_group[2]]) }}

                      {% endfor %}
                    </tr>
                  {% endfor %}

                  <tr class="bold">
                    <td>
                      {% trans %} Total Summary {% endtrans %}
                    </td>
                    {% for label, key_group in indicators %}

                        {{ performance_indicator_data(request, summary_row[key_group[0]],
                                                      summary_row[key_group[1]],
                                                      summary_row[key_group[2]]) }}

                    {% endfor %}
                  </tr>

                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <!-- END SAMPLE TABLE PORTLET-->
        </div>
    </div>
    {% endfor %}

{% endblock %}
{% block page_scripts %}
    <script src="{{ request.static_url('wkcdd:static/scripts/custom.js') }}"></script>
{% endblock %}
{% block jquery_ready %}
  {{ super() }}
  map = Custom.display_constituency_map();
  
  location_json_data = {{ filter_criteria["location_json_data"]|safe() }};
  LocationSelect.data_map = location_json_data;
  LocationSelect.url = '{{ request.route_path('performance_indicators', traverse=()) }}'

  {{ update_selected_location_dropdowns(search_criteria) }}
{% endblock %}    
